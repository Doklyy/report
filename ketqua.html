<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ - B√°o C√°o T·ªïng H·ª£p</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .nav-item {
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        .nav-item:hover { color: #9f224e; }
        .nav-item.active {
            color: #9f224e;
            font-weight: bold;
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #9f224e;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }
        tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        tbody tr:hover {
            background: #eff6ff !important;
        }
        .loading {
            text-align: center;
            padding: 2.5rem;
            color: #6b7280;
            font-size: 1rem;
        }
        .stat-number {
            font-size: 2.75rem;
        }
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- Thanh menu ƒëi·ªÅu h∆∞·ªõng -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-6xl mx-auto flex items-center px-4 h-12">
            <div class="flex items-center space-x-10 text-[16px] font-medium text-[#757575]">
                <a href="index.html" class="nav-item">ƒê·ªÅ xu·∫•t</a>
                <a href="ketqua.html" class="nav-item active">K·∫øt qu·∫£</a>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto mt-6">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">üìä K·∫øt qu·∫£ B√°o C√°o T·ªïng H·ª£p</h1>
            <p class="text-white opacity-90">T·ªïng h·ª£p t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ form b√°o c√°o</p>
        </div>

        <!-- Th·ªëng k√™ t·ªïng quan -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="stat-card">
                <div class="stat-label">T·ªïng s·ªë b√°o c√°o</div>
                <div class="stat-number" id="totalReports">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="stat-label">T·ªïng s·∫£n l∆∞·ª£ng</div>
                <div class="stat-number" id="totalVolume">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="stat-label">S·ªë kh√°ch h√†ng</div>
                <div class="stat-number" id="totalCustomers">0</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                <div class="stat-label">T·ª∑ l·ªá ho√†n TB</div>
                <div class="stat-number" id="avgReturnRate">0%</div>
            </div>
        </div>

        <!-- Bi·ªÉu ƒë·ªì -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="card">
                <h2 class="text-xl font-bold mb-4">üìà S·∫£n l∆∞·ª£ng theo khu v·ª±c</h2>
                <canvas id="volumeChart"></canvas>
            </div>
            <div class="card">
                <h2 class="text-xl font-bold mb-4">üè¢ Top 5 Ng√†nh h√†ng</h2>
                <canvas id="industryChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="card">
                <h2 class="text-xl font-bold mb-4">‚öîÔ∏è ƒê·ªëi th·ªß ƒë∆∞·ª£c s·ª≠ d·ª•ng</h2>
                <canvas id="competitorChart"></canvas>
            </div>
            <div class="card">
                <h2 class="text-xl font-bold mb-4">üìÖ B√°o c√°o theo th·ªùi gian</h2>
                <canvas id="timeChart"></canvas>
            </div>
        </div>

        <!-- B·∫£ng d·ªØ li·ªáu chi ti·∫øt - D·ªÖ nh√¨n, truy·ªÅn t·ª´ Google Sheet -->
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">üìã D·ªØ li·ªáu chi ti·∫øt t·ª´ Google Sheet</h2>
                <button onclick="refreshData()" class="bg-blue-500 hover:bg-blue-600 text-white px-5 py-2.5 rounded-lg transition-colors font-medium shadow-sm">
                    üîÑ L√†m m·ªõi
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>T√™n KH</th>
                            <th>ƒêi·ªán tho·∫°i</th>
                            <th>ƒê·ªãa ch·ªâ</th>
                            <th>T·ªïng SL</th>
                            <th>Ng√†nh h√†ng</th>
                            <th>ƒê·ªëi th·ªß</th>
                            <th>T·ª∑ l·ªá ho√†n</th>
                            <th>K·∫øt qu·∫£</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <tr>
                            <td colspan="10" class="loading">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw1SL2FNOlL0bWt7ED5E5A8PYcOJL-QBOZKpmoxh34ywbxmW-yY0cuGj26cU4BaZUzczA/exec';
        
        let volumeChart, industryChart, competitorChart, timeChart;

        // Load d·ªØ li·ªáu khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        async function loadData() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();
                
                if (result.success && result.data) {
                    processData(result.data);
                } else {
                    showError('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu');
            }
        }

        function processData(data) {
            if (!data || data.length === 0) {
                showError('Ch∆∞a c√≥ d·ªØ li·ªáu');
                return;
            }

            // C·∫≠p nh·∫≠t th·ªëng k√™
            updateStats(data);
            
            // V·∫Ω bi·ªÉu ƒë·ªì
            drawCharts(data);
            
            // Hi·ªÉn th·ªã b·∫£ng
            displayTable(data);
        }

        function updateStats(data) {
            const totalReports = data.length;
            document.getElementById('totalReports').textContent = totalReports;

            // T√≠nh t·ªïng s·∫£n l∆∞·ª£ng
            let totalVolume = 0;
            data.forEach(row => {
                const volume = parseFloat(row['T·ªïng s·∫£n l∆∞·ª£ng']) || 0;
                totalVolume += volume;
            });
            document.getElementById('totalVolume').textContent = formatNumber(totalVolume);

            // ƒê·∫øm s·ªë kh√°ch h√†ng unique
            const uniqueCustomers = new Set(data.map(row => row['T√™n KH/T√™n shop']));
            document.getElementById('totalCustomers').textContent = uniqueCustomers.size;

            // T√≠nh t·ª∑ l·ªá ho√†n trung b√¨nh
            let totalReturnRate = 0;
            let count = 0;
            data.forEach(row => {
                const rate = parseFloat(row['T·ª∑ l·ªá ho√†n ƒë·ªÅ xu·∫•t']) || parseFloat(row['T·ª∑ l·ªá ho√†n hi·ªán t·∫°i']) || 0;
                if (rate > 0) {
                    totalReturnRate += rate;
                    count++;
                }
            });
            const avgReturn = count > 0 ? (totalReturnRate / count).toFixed(1) : 0;
            document.getElementById('avgReturnRate').textContent = avgReturn + '%';
        }

        function drawCharts(data) {
            // Bi·ªÉu ƒë·ªì s·∫£n l∆∞·ª£ng theo khu v·ª±c
            const volumeData = {
                'N·ªôi t·ªânh': 0,
                'N·ªôi mi·ªÅn': 0,
                'C·∫≠n mi·ªÅn': 0,
                'Li√™n mi·ªÅn': 0
            };
            
            data.forEach(row => {
                volumeData['N·ªôi t·ªânh'] += parseFloat(row['S·∫£n l∆∞·ª£ng N·ªôi t·ªânh']) || 0;
                volumeData['N·ªôi mi·ªÅn'] += parseFloat(row['S·∫£n l∆∞·ª£ng N·ªôi mi·ªÅn']) || 0;
                volumeData['C·∫≠n mi·ªÅn'] += parseFloat(row['S·∫£n l∆∞·ª£ng C·∫≠n mi·ªÅn']) || 0;
                volumeData['Li√™n mi·ªÅn'] += parseFloat(row['S·∫£n l∆∞·ª£ng Li√™n mi·ªÅn']) || 0;
            });

            if (volumeChart) volumeChart.destroy();
            const volumeCtx = document.getElementById('volumeChart').getContext('2d');
            volumeChart = new Chart(volumeCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(volumeData),
                    datasets: [{
                        label: 'S·∫£n l∆∞·ª£ng',
                        data: Object.values(volumeData),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(245, 87, 108, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Bi·ªÉu ƒë·ªì ng√†nh h√†ng
            const industryCount = {};
            data.forEach(row => {
                const industries = (row['Ng√†nh h√†ng'] || '').split(';').map(i => i.trim()).filter(i => i);
                industries.forEach(ind => {
                    industryCount[ind] = (industryCount[ind] || 0) + 1;
                });
            });
            const topIndustries = Object.entries(industryCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            if (industryChart) industryChart.destroy();
            const industryCtx = document.getElementById('industryChart').getContext('2d');
            industryChart = new Chart(industryCtx, {
                type: 'doughnut',
                data: {
                    labels: topIndustries.map(i => i[0]),
                    datasets: [{
                        data: topIndustries.map(i => i[1]),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(67, 233, 123, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Bi·ªÉu ƒë·ªì ƒë·ªëi th·ªß
            const competitorCount = {};
            data.forEach(row => {
                const competitors = (row['ƒê·ªëi th·ªß'] || '').split(';').map(c => c.trim()).filter(c => c);
                competitors.forEach(comp => {
                    competitorCount[comp] = (competitorCount[comp] || 0) + 1;
                });
            });

            if (competitorChart) competitorChart.destroy();
            const competitorCtx = document.getElementById('competitorChart').getContext('2d');
            competitorChart = new Chart(competitorCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(competitorCount),
                    datasets: [{
                        data: Object.values(competitorCount),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(79, 172, 254, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true
                }
            });

            // Bi·ªÉu ƒë·ªì theo th·ªùi gian
            const timeData = {};
            data.forEach(row => {
                const date = (row['Th·ªùi gian'] || '').split(' ')[0]; // L·∫•y ph·∫ßn ng√†y
                if (date) {
                    timeData[date] = (timeData[date] || 0) + 1;
                }
            });
            const sortedDates = Object.keys(timeData).sort();

            if (timeChart) timeChart.destroy();
            const timeCtx = document.getElementById('timeChart').getContext('2d');
            timeChart = new Chart(timeCtx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [{
                        label: 'S·ªë b√°o c√°o',
                        data: sortedDates.map(d => timeData[d]),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function displayTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';

            // S·∫Øp x·∫øp theo th·ªùi gian m·ªõi nh·∫•t
            const sortedData = [...data].sort((a, b) => {
                return new Date(b['Th·ªùi gian']) - new Date(a['Th·ªùi gian']);
            });

            sortedData.forEach(row => {
                const tr = document.createElement('tr');
                const addr = (row['ƒê·ªãa ch·ªâ'] || '');
                const industry = (row['Ng√†nh h√†ng'] || '');
                const competitor = (row['ƒê·ªëi th·ªß'] || '');
                tr.innerHTML = `
                    <td class="whitespace-nowrap">${row['Th·ªùi gian'] || ''}</td>
                    <td>${row['T√™n KH/T√™n shop'] || ''}</td>
                    <td class="whitespace-nowrap">${row['ƒêi·ªán tho·∫°i'] || ''}</td>
                    <td>${addr.length > 35 ? addr.substring(0, 35) + '...' : addr}</td>
                    <td class="text-right font-medium">${formatNumber(parseFloat(row['T·ªïng s·∫£n l∆∞·ª£ng']) || 0)}</td>
                    <td>${industry.length > 25 ? industry.substring(0, 25) + '...' : industry}</td>
                    <td>${competitor.length > 15 ? competitor.substring(0, 15) + '...' : competitor}</td>
                    <td class="whitespace-nowrap">${row['T·ª∑ l·ªá ho√†n ƒë·ªÅ xu·∫•t'] || row['T·ª∑ l·ªá ho√†n hi·ªán t·∫°i'] || '0'}%</td>
                    <td class="text-amber-700 font-medium">${row['K·∫øt qu·∫£'] || '-'}</td>
                    <td class="text-gray-600">${row['Ghi ch√∫'] || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }

        function showError(message) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = `<tr><td colspan="10" class="loading">${message}</td></tr>`;
        }

        async function refreshData() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '<tr><td colspan="10" class="loading">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ Google Sheet...</td></tr>';
            await loadData();
        }
    </script>
</body>
</html>
