<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả đề xuất chính sách giá</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .nav-item {
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        .nav-item:hover { color: #9f224e; }
        .nav-item.active { color: #9f224e; font-weight: bold; }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #9f224e;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-approved { background-color: #dcfce7; color: #166534; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .table-scroll { overflow-x: auto; }
    </style>
</head>
<body class="bg-[#f0f2f5] min-h-screen font-sans text-gray-800">

    <!-- THANH MENU ĐIỀU HƯỚNG -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-6xl mx-auto flex items-center px-4 h-12">
            <div class="flex items-center space-x-10 text-[16px] font-medium text-[#757575]">
                <a href="index.html" class="nav-item">Đề xuất</a>
                <a href="ketqua.html" class="nav-item active">Kết quả</a>
            </div>
        </div>
    </nav>

    <!-- GIAO DIỆN KẾT QUẢ -->
    <main class="max-w-6xl mx-auto mt-8 p-4">
        <!-- Thanh tìm kiếm -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-blue-100 mb-8">
            <div class="p-8 text-center border-b border-gray-100 bg-gradient-to-b from-white to-blue-50">
                <h1 class="text-2xl font-bold text-[#1e293b] mb-4">Tra cứu kết quả đề xuất</h1>
                <div class="max-w-md mx-auto relative">
                    <input type="tel" id="phoneSearch" placeholder="Nhập số điện thoại khách hàng..." 
                           class="w-full pl-12 pr-4 py-3 border-2 border-blue-200 rounded-full focus:border-blue-500 focus:ring-0 outline-none transition-all shadow-sm"
                           oninput="handleSearch(this.value)">
                    <div class="absolute left-4 top-3.5 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <p class="mt-3 text-sm text-gray-500 italic">Nhập số điện thoại để lọc hoặc để trống để xem tất cả</p>
            </div>
        </div>

        <!-- Nút lọc & Làm mới -->
        <div class="flex flex-wrap gap-3 mb-6 justify-between items-center">
            <div class="flex flex-wrap gap-3">
                <button onclick="filterResults('all')" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg font-medium text-slate-700 transition">Tất cả</button>
                <button onclick="filterResults('Phê duyệt')" class="px-4 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg font-medium transition">Phê duyệt</button>
                <button onclick="filterResults('Từ chối')" class="px-4 py-2 bg-rose-100 text-rose-700 hover:bg-rose-200 rounded-lg font-medium transition">Từ chối</button>
                <button onclick="filterResults('Bổ sung')" class="px-4 py-2 bg-amber-100 text-amber-700 hover:bg-amber-200 rounded-lg font-medium transition">Bổ sung</button>
            </div>
            <button onclick="loadData()" class="px-4 py-2 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg font-medium transition">
                <i class="fas fa-sync-alt mr-1"></i> Làm mới
            </button>
        </div>

        <!-- Thống kê -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Đã Phê Duyệt</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="stat-approved">0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-rose-600">
                    <i class="fas fa-times-circle text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Đã Từ Chối</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="stat-rejected">0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Cần Bổ Sung</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="stat-pending">0</h3>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading-state" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-slate-400 text-5xl mb-4"></i>
            <p class="text-slate-500">Đang tải dữ liệu từ Google Sheet...</p>
        </div>

        <!-- Bảng danh sách phiếu đề xuất -->
        <div id="resultArea" class="hidden bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 mb-8">
            <div class="p-6 border-b border-gray-100">
                <h2 class="font-bold text-gray-700 uppercase tracking-wider text-sm">Danh sách phiếu đề xuất</h2>
                <span id="customerName" class="text-blue-700 font-bold ml-2"></span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                        <tr>
                            <th class="px-6 py-3 border-b">Mã Phiếu</th>
                            <th class="px-6 py-3 border-b">Tên KH</th>
                            <th class="px-6 py-3 border-b">Ngày gửi</th>
                            <th class="px-6 py-3 border-b">Nội dung</th>
                            <th class="px-6 py-3 border-b text-center">Trạng thái</th>
                            <th class="px-6 py-3 border-b">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="resultTableBody" class="divide-y divide-gray-100">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trạng thái trống -->
        <div id="emptyArea" class="hidden p-20 text-center text-gray-400 bg-white rounded-xl border border-gray-200">
            <i class="fas fa-search text-gray-200 text-6xl mb-4"></i>
            <p>Đang tải dữ liệu hoặc không tìm thấy kết quả phù hợp</p>
        </div>

        <!-- Bảng dữ liệu SPHN (Đề xuất chính sách giá hàng nặng) -->
        <div id="sphnTableSection" class="mt-12 bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
            <div class="p-6 border-b border-gray-100 bg-gradient-to-r from-blue-50 to-indigo-50">
                <h2 class="text-xl font-bold text-slate-800">
                    <i class="fas fa-table mr-2 text-blue-600"></i>Bảng dữ liệu SPHN
                </h2>
                <p class="text-sm text-slate-500 mt-1">Dữ liệu đề xuất chính sách giá hàng nặng từ Google Sheet</p>
            </div>
            <div class="table-scroll p-4">
                <table class="w-full text-sm text-left min-w-[800px]">
                    <thead class="bg-slate-100 text-slate-600 uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3 border">Thời gian</th>
                            <th class="px-4 py-3 border">Tên KH</th>
                            <th class="px-4 py-3 border">Điện thoại</th>
                            <th class="px-4 py-3 border">Địa chỉ</th>
                            <th class="px-4 py-3 border">Ngành hàng</th>
                            <th class="px-4 py-3 border">Đối thủ</th>
                            <th class="px-4 py-3 border">Tổng SL</th>
                            <th class="px-4 py-3 border text-center">Kết quả</th>
                            <th class="px-4 py-3 border">Ghi chú</th>
                        </tr>
                    </thead>
                    <tbody id="sphnTableBody" class="divide-y divide-gray-100">
                        <tr><td colspan="9" class="px-4 py-8 text-center text-gray-400">Đang tải...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXH7AcaybEumsO-M2pWkxZEEJ9YVmRWmKplLGhqqzg7zn6Jj5uOcdIu_YByFkxpbaUzA/exec';
        let allData = [];
        let currentFilter = 'all';

        function normalizeStatus(s) {
            if (!s || typeof s !== 'string') return 'Khác';
            const t = s.trim().toLowerCase();
            if (t.includes('phê duyệt')) return 'Phê duyệt';
            if (t.includes('từ chối')) return 'Từ chối';
            if (t.includes('bổ sung')) return 'Bổ sung';
            return s.trim() || 'Chờ xử lý';
        }

        function getStatusBadgeClass(status) {
            const n = normalizeStatus(status);
            if (n === 'Phê duyệt') return 'status-badge status-approved';
            if (n === 'Từ chối') return 'status-badge status-rejected';
            if (n === 'Bổ sung') return 'status-badge status-pending';
            return 'status-badge status-pending';
        }

        function transformSheetData(rows) {
            let lastStatus = '', lastNote = '';
            const items = [];
            const seen = new Set();
            
            rows.forEach((row) => {
                const name = (row['Tên KH/Tên shop'] || row['Tên KH'] || '').toString().trim();
                let status = (row['Kết quả'] || '').toString().trim();
                let note = (row['Ghi chú'] || '').toString().trim();
                const time = (row['Thời gian'] || '').toString().trim();
                const phone = (row['Điện thoại'] || '').toString().trim();
                
                if (status) lastStatus = status;
                else status = lastStatus;
                if (note) lastNote = note;
                else note = lastNote;
                
                const key = `${time}_${name}`;
                if (seen.has(key)) return;
                seen.add(key);
                if (!name) return;
                
                items.push({
                    id: `#DX-${String(items.length + 1).padStart(4, '0')}`,
                    name, status, note, time, phone,
                    address: row['Địa chỉ'] || '',
                    volume: row['Tổng sản lượng'] || '',
                    industry: row['Ngành hàng'] || '',
                    competitor: row['Đối thủ'] || ''
                });
            });
            return items;
        }

        function handleSearch(val) {
            const phone = (val || '').replace(/\s/g, '');
            const filtered = phone.length >= 10 
                ? allData.filter(i => (i.phone || '').replace(/\s/g, '').includes(phone))
                : applyFilter(allData);
            
            renderTable(filtered);
            if (filtered.length > 0 && phone.length >= 10) {
                document.getElementById('customerName').textContent = 'KH: ' + (filtered[0].name || '');
            } else {
                document.getElementById('customerName').textContent = phone.length >= 10 ? 'Không tìm thấy' : '';
            }
        }

        function applyFilter(data) {
            if (currentFilter === 'all') return data;
            return data.filter(i => normalizeStatus(i.status) === currentFilter);
        }

        function filterResults(status) {
            currentFilter = status;
            const phone = document.getElementById('phoneSearch').value.replace(/\s/g, '');
            let filtered = phone.length >= 10 
                ? allData.filter(i => (i.phone || '').replace(/\s/g, '').includes(phone))
                : allData;
            filtered = applyFilter(filtered);
            renderTable(filtered);
        }

        function renderTable(data) {
            const resultArea = document.getElementById('resultArea');
            const emptyArea = document.getElementById('emptyArea');
            const tbody = document.getElementById('resultTableBody');
            
            if (data.length === 0) {
                resultArea.classList.add('hidden');
                emptyArea.classList.remove('hidden');
                return;
            }
            
            resultArea.classList.remove('hidden');
            emptyArea.classList.add('hidden');
            
            tbody.innerHTML = data.map(item => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 font-medium text-blue-600">${item.id}</td>
                    <td class="px-6 py-4">${item.name}</td>
                    <td class="px-6 py-4 text-gray-500">${item.time}</td>
                    <td class="px-6 py-4">${item.industry || '-'} / ${item.competitor || '-'}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="${getStatusBadgeClass(item.status)}">${item.status || 'Chờ xử lý'}</span>
                    </td>
                    <td class="px-6 py-4 text-gray-600 text-xs max-w-[200px] truncate" title="${(item.note || '').replace(/"/g, '')}">${item.note || '-'}</td>
                </tr>
            `).join('');
        }

        function renderSPHNTable(rows) {
            const tbody = document.getElementById('sphnTableBody');
            if (!rows || rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-400">Chưa có dữ liệu</td></tr>';
                return;
            }
            
            let lastStatus = '', lastNote = '';
            const seen = new Set();
            
            tbody.innerHTML = rows.map((row, idx) => {
                const name = (row['Tên KH/Tên shop'] || row['Tên KH'] || '').toString().trim();
                let status = (row['Kết quả'] || '').toString().trim();
                let note = (row['Ghi chú'] || '').toString().trim();
                if (status) lastStatus = status;
                else status = lastStatus;
                if (note) lastNote = note;
                else note = lastNote;
                
                const key = `${row['Thời gian']}_${name}_${idx}`;
                if (seen.has(key)) return '';
                seen.add(key);
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3 border text-gray-600">${row['Thời gian'] || '-'}</td>
                    <td class="px-4 py-3 border font-medium">${name || '-'}</td>
                    <td class="px-4 py-3 border">${row['Điện thoại'] || '-'}</td>
                    <td class="px-4 py-3 border max-w-[150px] truncate" title="${(row['Địa chỉ'] || '').replace(/"/g, '')}">${row['Địa chỉ'] || '-'}</td>
                    <td class="px-4 py-3 border max-w-[120px] truncate">${row['Ngành hàng'] || '-'}</td>
                    <td class="px-4 py-3 border">${row['Đối thủ'] || '-'}</td>
                    <td class="px-4 py-3 border text-right">${row['Tổng sản lượng'] || '-'}</td>
                    <td class="px-4 py-3 border text-center"><span class="${getStatusBadgeClass(status)}">${status || '-'}</span></td>
                    <td class="px-4 py-3 border max-w-[180px] truncate text-xs" title="${(note || '').replace(/"/g, '')}">${note || '-'}</td>
                </tr>
                `;
            }).join('');
        }

        function updateStats(data) {
            const d = data || allData;
            document.getElementById('stat-approved').innerText = d.filter(i => normalizeStatus(i.status) === 'Phê duyệt').length;
            document.getElementById('stat-rejected').innerText = d.filter(i => normalizeStatus(i.status) === 'Từ chối').length;
            document.getElementById('stat-pending').innerText = d.filter(i => normalizeStatus(i.status) === 'Bổ sung').length;
        }

        async function loadData() {
            const loadingState = document.getElementById('loading-state');
            const emptyArea = document.getElementById('emptyArea');
            const resultArea = document.getElementById('resultArea');
            
            loadingState.classList.remove('hidden');
            emptyArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();
                
                if (result.success && result.data) {
                    allData = transformSheetData(result.data);
                    const filtered = applyFilter(allData);
                    renderTable(filtered);
                    renderSPHNTable(result.data);
                    updateStats(allData);
                    
                    if (filtered.length > 0) {
                        resultArea.classList.remove('hidden');
                    } else {
                        emptyArea.classList.remove('hidden');
                    }
                } else {
                    allData = [];
                    renderTable([]);
                    renderSPHNTable([]);
                    updateStats([]);
                    emptyArea.classList.remove('hidden');
                }
                loadingState.classList.add('hidden');
            } catch (error) {
                console.error('Error:', error);
                loadingState.classList.add('hidden');
                emptyArea.classList.remove('hidden');
                document.getElementById('emptyArea').innerHTML = `
                    <i class="fas fa-exclamation-circle text-rose-400 text-6xl mb-4"></i>
                    <p class="text-slate-600 mb-2">Có lỗi khi tải dữ liệu</p>
                    <button onclick="loadData()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium mt-4">Thử lại</button>
                `;
            }
        }

        window.onload = () => loadData();
    </script>
</body>
</html>
