<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả đề xuất chính sách giá</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .nav-item {
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        .nav-item:hover { color: #9f224e; }
        .nav-item.active { color: #9f224e; font-weight: bold; }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #9f224e;
        }
        .status-badge {
            padding: 8px 16px;
            border-radius: 9999px;
            font-size: 14px;
            font-weight: 600;
        }
        .status-approved { background-color: #dcfce7; color: #166534; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
        .status-pending { background-color: #fef3c7; color: #92400e; }
        .status-waiting { background-color: #e0e7ff; color: #3730a3; }
    </style>
</head>
<body class="bg-[#f0f2f5] min-h-screen font-sans text-gray-800">

    <!-- THANH MENU ĐIỀU HƯỚNG -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
        <div class="max-w-6xl mx-auto flex items-center px-4 h-12">
            <div class="flex items-center space-x-10 text-[16px] font-medium text-[#757575]">
                <a href="index.html" class="nav-item">Đề xuất</a>
                <a href="ketqua.html" class="nav-item active">Kết quả</a>
            </div>
        </div>
    </nav>

    <!-- GIAO DIỆN KẾT QUẢ -->
    <main class="max-w-2xl mx-auto mt-12 p-4">
        <!-- Thanh tìm kiếm -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-blue-100 mb-8">
            <div class="p-8 text-center border-b border-gray-100 bg-gradient-to-b from-white to-blue-50">
                <h1 class="text-2xl font-bold text-[#1e293b] mb-4">Tra cứu kết quả đề xuất</h1>
                <div class="max-w-md mx-auto relative">
                    <input type="tel" id="phoneSearch" placeholder="Nhập số điện thoại khách hàng..." 
                           class="w-full pl-12 pr-4 py-3 border-2 border-blue-200 rounded-full focus:border-blue-500 focus:ring-0 outline-none transition-all shadow-sm"
                           oninput="handleSearch()">
                    <div class="absolute left-4 top-3.5 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
                <p class="mt-3 text-sm text-gray-500 italic">Nhập số điện thoại để xem kết quả phê duyệt</p>
            </div>
        </div>

        <!-- Thông tin bảng dữ liệu SPHN -->
        <div class="bg-white rounded-xl shadow border border-gray-200 p-4 mb-6 flex flex-wrap items-center gap-2">
            <span class="text-slate-600 font-medium">Bảng dữ liệu của SPHN</span>
            <span class="text-slate-400">|</span>
            <a href="https://docs.google.com/spreadsheets/d/1538u5QD9QeTKOLOKHxXcTyiwzV7b3NdEYaATzaEG60s/edit?gid=0#gid=0" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-700 hover:underline font-medium inline-flex items-center gap-1">
                <i class="fas fa-external-link-alt text-sm"></i> Google Sheet
            </a>
        </div>

        <!-- Loading -->
        <div id="loading-state" class="text-center py-12">
            <i class="fas fa-spinner fa-spin text-slate-400 text-4xl mb-4"></i>
            <p class="text-slate-500">Đang tải dữ liệu...</p>
        </div>

        <!-- Chưa nhập số điện thoại -->
        <div id="promptArea" class="hidden text-center py-16 bg-white rounded-xl border border-gray-200">
            <i class="fas fa-phone-alt text-blue-200 text-6xl mb-4"></i>
            <p class="text-gray-500">Vui lòng nhập số điện thoại khách hàng để tra cứu kết quả</p>
        </div>

        <!-- Không tìm thấy -->
        <div id="notFoundArea" class="hidden text-center py-16 bg-white rounded-xl border border-gray-200">
            <i class="fas fa-search text-gray-300 text-6xl mb-4"></i>
            <p class="text-gray-600 font-medium">Không tìm thấy thông tin</p>
            <p class="text-gray-500 text-sm mt-2">Không có kết quả cho số điện thoại này</p>
        </div>

        <!-- Kết quả tra cứu -->
        <div id="resultArea" class="hidden space-y-4">
            <!-- Cards sẽ được render ở đây -->
        </div>

        <!-- Lỗi tải dữ liệu -->
        <div id="errorArea" class="hidden p-12 text-center bg-white rounded-xl border border-gray-200">
            <i class="fas fa-exclamation-circle text-rose-400 text-6xl mb-4"></i>
            <p class="text-slate-600 mb-2">Có lỗi khi tải dữ liệu</p>
            <button onclick="loadData()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium mt-4">Thử lại</button>
        </div>
    </main>

    <script>
        // Dùng CÙNG URL với form gửi dữ liệu (script.js) - doGet đọc từ cùng sheet
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwchdja-3mDkc3OqC9dqgQ721L8lZNNxt45wcAq1Cim3IacpwxKjFjALv0bHiXhBJQIAw/exec';
        let allData = [];

        function normalizeStatus(s) {
            if (!s || typeof s !== 'string' || !s.trim()) return 'Chờ kết quả';
            const t = s.trim().toLowerCase();
            if (t.includes('phê duyệt')) return 'Phê duyệt';
            if (t.includes('từ chối')) return 'Từ chối';
            if (t.includes('bổ sung')) return 'Bổ sung';
            return 'Chờ kết quả';
        }

        function getStatusBadgeClass(status) {
            const n = normalizeStatus(status);
            if (n === 'Chờ kết quả') return 'status-badge status-waiting';
            if (n === 'Phê duyệt') return 'status-badge status-approved';
            if (n === 'Từ chối') return 'status-badge status-rejected';
            if (n === 'Bổ sung') return 'status-badge status-pending';
            return 'status-badge status-waiting';
        }

        function transformSheetData(rows) {
            let lastStatus = '', lastNote = '';
            const items = [];
            const seen = new Set();

            rows.forEach((row) => {
                const name = (row['Tên KH/Tên shop'] || row['Tên KH'] || '').toString().trim();
                let status = (row['Kết quả'] || '').toString().trim();
                let note = (row['Ghi chú'] || '').toString().trim();
                const time = (row['Thời gian'] || '').toString().trim();
                const phone = (row['Điện thoại'] || '').toString().trim();
                const address = (row['Địa chỉ'] || '').toString().trim();

                if (status) lastStatus = status;
                else status = lastStatus;
                if (note) lastNote = note;
                else note = lastNote;

                const key = `${time}_${name}`;
                if (seen.has(key)) return;
                seen.add(key);
                if (!name) return;

                items.push({
                    name, status, note, time, phone, address
                });
            });
            return items;
        }

        function handleSearch() {
            const phone = (document.getElementById('phoneSearch').value || '').replace(/\s/g, '');
            const loadingState = document.getElementById('loading-state');
            const promptArea = document.getElementById('promptArea');
            const notFoundArea = document.getElementById('notFoundArea');
            const resultArea = document.getElementById('resultArea');

            loadingState.classList.add('hidden');
            promptArea.classList.add('hidden');
            notFoundArea.classList.add('hidden');
            resultArea.classList.add('hidden');

            if (phone.length < 10) {
                promptArea.classList.remove('hidden');
                return;
            }

            // Chuẩn hóa SĐT: bỏ khoảng trắng, so sánh có/không có số 0 đầu
            const normalizePhone = (p) => (p || '').toString().replace(/\s/g, '').replace(/^0+/, '') || '';
            const phoneNorm = normalizePhone(phone);
            const filtered = allData.filter(i => {
                const p = normalizePhone(i.phone);
                return p === phoneNorm || (i.phone || '').replace(/\s/g, '').includes(phone) || phone.includes(p);
            });

            if (filtered.length === 0) {
                notFoundArea.classList.remove('hidden');
                return;
            }

            resultArea.classList.remove('hidden');
            renderResultCards(filtered);
        }

        function renderResultCards(items) {
            const container = document.getElementById('resultArea');
            container.innerHTML = items.map(item => `
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                    <div class="p-6">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-user text-blue-600"></i> Thông tin cá nhân
                        </h3>
                        <dl class="space-y-2 text-sm">
                            <div class="flex">
                                <dt class="text-gray-500 w-24 flex-shrink-0">Tên KH:</dt>
                                <dd class="font-medium text-slate-800">${item.name || '-'}</dd>
                            </div>
                            <div class="flex">
                                <dt class="text-gray-500 w-24 flex-shrink-0">Điện thoại:</dt>
                                <dd class="font-medium text-slate-800">${item.phone || '-'}</dd>
                            </div>
                            <div class="flex">
                                <dt class="text-gray-500 w-24 flex-shrink-0">Địa chỉ:</dt>
                                <dd class="text-slate-700">${item.address || '-'}</dd>
                            </div>
                        </dl>

                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-check-circle text-blue-600"></i> Kết quả
                            </h3>
                            <p class="mb-2">
                                <span class="${getStatusBadgeClass(item.status)}">${item.status || 'Chờ kết quả'}</span>
                            </p>
                            <p class="text-sm text-gray-600">
                                ${item.status === 'Phê duyệt' ? 'Đề xuất đã được phê duyệt.' : 
                                  item.status === 'Từ chối' ? 'Đề xuất đã bị từ chối.' : 
                                  item.status === 'Bổ sung' ? 'Cần bổ sung thông tin.' : 
                                  'Đang chờ xử lý.'}
                            </p>
                        </div>

                        ${(item.note || '').trim() ? `
                        <div class="mt-4 pt-4 border-t border-gray-100">
                            <h3 class="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i class="fas fa-sticky-note text-amber-600"></i> Ghi chú
                            </h3>
                            <p class="text-sm text-slate-600 bg-amber-50 p-3 rounded-lg">${(item.note || '').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function loadData() {
            const loadingState = document.getElementById('loading-state');
            const promptArea = document.getElementById('promptArea');
            const notFoundArea = document.getElementById('notFoundArea');
            const resultArea = document.getElementById('resultArea');
            const errorArea = document.getElementById('errorArea');

            loadingState.classList.remove('hidden');
            promptArea.classList.add('hidden');
            notFoundArea.classList.add('hidden');
            resultArea.classList.add('hidden');
            errorArea.classList.add('hidden');

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();

                if (result.success && result.data) {
                    allData = transformSheetData(result.data);
                    loadingState.classList.add('hidden');
                    handleSearch();
                } else {
                    allData = [];
                    loadingState.classList.add('hidden');
                    promptArea.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error:', error);
                loadingState.classList.add('hidden');
                errorArea.classList.remove('hidden');
            }
        }

        window.onload = () => loadData();
    </script>
</body>
</html>
