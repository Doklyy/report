<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Kết Quả - Báo Cáo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .nav-item {
            white-space: nowrap;
            transition: all 0.2s;
            position: relative;
        }
        .nav-item:hover { color: #9f224e; }
        .nav-item.active {
            color: #9f224e;
            font-weight: bold;
        }
        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #9f224e;
        }
        .status-badge {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Thanh menu điều hướng -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm -mt-4 -mx-4 md:-mx-8 px-4 md:px-8 mb-6">
        <div class="max-w-6xl mx-auto flex items-center h-12">
            <div class="flex items-center space-x-10 text-[16px] font-medium text-[#757575]">
                <a href="index.html" class="nav-item">Đề xuất</a>
                <a href="ketqua.html" class="nav-item active">Kết quả</a>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto">
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <h1 class="text-3xl font-bold text-slate-800">Bảng Kết Quả Phê Duyệt</h1>
            
            <div class="flex flex-nowrap gap-3 flex-shrink-0 overflow-x-auto pb-1">
                <button onclick="filterResults('all')" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg font-medium text-slate-700 transition whitespace-nowrap">Tất cả</button>
                <button onclick="filterResults('Phê duyệt')" class="px-4 py-2 bg-emerald-100 text-emerald-700 hover:bg-emerald-200 rounded-lg font-medium transition whitespace-nowrap">Phê duyệt</button>
                <button onclick="filterResults('Từ chối')" class="px-4 py-2 bg-rose-100 text-rose-700 hover:bg-rose-200 rounded-lg font-medium transition whitespace-nowrap">Từ chối</button>
                <button onclick="filterResults('Bổ sung')" class="px-4 py-2 bg-amber-100 text-amber-700 hover:bg-amber-200 rounded-lg font-medium transition whitespace-nowrap">Bổ sung</button>
                <button onclick="loadData()" class="px-4 py-2 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded-lg font-medium transition whitespace-nowrap">
                    <i class="fas fa-sync-alt mr-1"></i> Làm mới
                </button>
            </div>
        </div>

        <!-- Stats Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center text-emerald-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Đã Phê Duyệt</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="stat-approved">0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center text-rose-600">
                    <i class="fas fa-times-circle text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Đã Từ Chối</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="stat-rejected">0</h3>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4">
                <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center text-amber-600">
                    <i class="fas fa-exclamation-triangle text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-slate-500 font-medium">Cần Bổ Sung</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="stat-pending">0</h3>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-20">
            <i class="fas fa-spinner fa-spin text-slate-400 text-5xl mb-4"></i>
            <p class="text-slate-500">Đang tải dữ liệu từ Google Sheet...</p>
        </div>

        <!-- Main Content List -->
        <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 hidden">
            <!-- Dữ liệu từ Google Sheet sẽ được render ở đây -->
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="hidden text-center py-20">
            <i class="fas fa-search text-slate-300 text-6xl mb-4"></i>
            <p class="text-slate-500 text-lg">Không tìm thấy kết quả nào phù hợp.</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden text-center py-20">
            <i class="fas fa-exclamation-circle text-rose-400 text-6xl mb-4"></i>
            <p class="text-slate-600 text-lg mb-2" id="error-message">Có lỗi xảy ra khi tải dữ liệu.</p>
            <button onclick="loadData()" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium mt-4">
                Thử lại
            </button>
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXH7AcaybEumsO-M2pWkxZEEJ9YVmRWmKplLGhqqzg7zn6Jj5uOcdIu_YByFkxpbaUzA/exec';
        let allData = []; // Lưu toàn bộ dữ liệu từ Google Sheet

        function normalizeStatus(status) {
            if (!status || typeof status !== 'string') return 'Khác';
            const s = status.trim().toLowerCase();
            if (s.includes('phê duyệt') || s === 'phê duyệt') return 'Phê duyệt';
            if (s.includes('từ chối') || s === 'từ chối') return 'Từ chối';
            if (s.includes('bổ sung') || s === 'bổ sung') return 'Bổ sung';
            return status.trim() || 'Khác';
        }

        function getStatusClasses(status) {
            const norm = normalizeStatus(status);
            switch(norm) {
                case 'Phê duyệt': return 'bg-emerald-100 text-emerald-700 border-emerald-200';
                case 'Từ chối': return 'bg-rose-100 text-rose-700 border-rose-200';
                case 'Bổ sung': return 'bg-amber-100 text-amber-700 border-amber-200';
                default: return 'bg-slate-100 text-slate-700 border-slate-200';
            }
        }

        function getStatusIcon(status) {
            const norm = normalizeStatus(status);
            switch(norm) {
                case 'Phê duyệt': return 'fa-check-circle';
                case 'Từ chối': return 'fa-times-circle';
                case 'Bổ sung': return 'fa-info-circle';
                default: return 'fa-question-circle';
            }
        }

        function transformSheetData(rows) {
            // Chuyển dữ liệu từ Google Sheet thành format card
            // Xử lý merged cells: Kết quả/Ghi chú có thể rỗng ở các dòng sau
            let lastStatus = '', lastNote = '';
            const items = [];
            const seen = new Set(); // Gộp theo Tên KH + Thời gian (1 hồ sơ = 1 card)
            
            rows.forEach((row, idx) => {
                const name = (row['Tên KH/Tên shop'] || row['Tên KH'] || '').toString().trim();
                let status = (row['Kết quả'] || '').toString().trim();
                let note = (row['Ghi chú'] || '').toString().trim();
                const time = (row['Thời gian'] || '').toString().trim();
                const phone = (row['Điện thoại'] || '').toString().trim();
                
                if (status) lastStatus = status;
                else status = lastStatus;
                if (note) lastNote = note;
                else note = lastNote;
                
                const key = `${time}_${name}`;
                if (seen.has(key)) return; // Chỉ lấy 1 card/hồ sơ (tránh trùng nhiều mốc trọng lượng)
                seen.add(key);
                
                if (!name) return;
                
                items.push({
                    id: `HS-${String(items.length + 1).padStart(3, '0')}`,
                    name: name || 'Không có tên',
                    status: status,
                    note: note,
                    time: time,
                    phone: phone,
                    address: row['Địa chỉ'] || '',
                    volume: row['Tổng sản lượng'] || '',
                    industry: row['Ngành hàng'] || '',
                    competitor: row['Đối thủ'] || ''
                });
            });
            return items;
        }

        function renderData(data) {
            const container = document.getElementById('results-container');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            
            loadingState.classList.add('hidden');
            errorState.classList.add('hidden');
            
            if (data.length === 0) {
                container.innerHTML = '';
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                updateStats(allData);
                return;
            }
            
            emptyState.classList.add('hidden');
            container.classList.remove('hidden');
            
            container.innerHTML = data.map(item => `
                <div class="bg-white rounded-2xl p-6 border border-slate-100 shadow-sm card-hover transition-all duration-300">
                    <div class="flex justify-between items-start mb-4">
                        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">${item.id}</span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold border ${getStatusClasses(item.status)}">
                            <i class="fas ${getStatusIcon(item.status)} mr-1"></i> ${item.status || 'Chờ xử lý'}
                        </span>
                    </div>
                    <h4 class="text-lg font-semibold text-slate-800 mb-1">${item.name}</h4>
                    ${item.time ? `<p class="text-xs text-slate-400 mb-3">${item.time}</p>` : ''}
                    <div class="bg-slate-50 p-3 rounded-xl">
                        <p class="text-sm text-slate-600 italic">
                            <span class="font-medium text-slate-400 not-italic uppercase text-[10px] block mb-1">Ghi chú (AV):</span>
                            "${item.note || 'Chưa có ghi chú'}"
                        </p>
                    </div>
                    ${item.phone ? `<p class="text-xs text-slate-500 mt-2"><i class="fas fa-phone mr-1"></i>${item.phone}</p>` : ''}
                </div>
            `).join('');

            updateStats(allData);
        }

        function updateStats(data) {
            const approved = data.filter(i => normalizeStatus(i.status) === 'Phê duyệt').length;
            const rejected = data.filter(i => normalizeStatus(i.status) === 'Từ chối').length;
            const pending = data.filter(i => normalizeStatus(i.status) === 'Bổ sung').length;
            
            document.getElementById('stat-approved').innerText = approved;
            document.getElementById('stat-rejected').innerText = rejected;
            document.getElementById('stat-pending').innerText = pending;
        }

        function filterResults(status) {
            if (status === 'all') {
                renderData(allData);
            } else {
                const filtered = allData.filter(item => normalizeStatus(item.status) === status);
                renderData(filtered);
            }
        }

        async function loadData() {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const container = document.getElementById('results-container');
            
            loadingState.classList.remove('hidden');
            errorState.classList.add('hidden');
            container.classList.add('hidden');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();
                
                if (result.success && result.data && result.data.length > 0) {
                    allData = transformSheetData(result.data);
                    renderData(allData);
                } else if (result.success && (!result.data || result.data.length === 0)) {
                    allData = [];
                    renderData([]);
                } else {
                    throw new Error(result.error || 'Không thể tải dữ liệu');
                }
            } catch (error) {
                console.error('Error:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                document.getElementById('error-message').textContent = 
                    error.message || 'Có lỗi xảy ra khi tải dữ liệu từ Google Sheet.';
            }
        }

        window.onload = () => loadData();
    </script>
</body>
</html>
